<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ETF 統計計算小工具（TWSE OpenAPI）</title>
  <style>
    :root{
      --ink:#1f2a3a;
      --muted:#627289;
      --line:#e6eef7;
      --card: rgba(255,255,255,.74);
      --card2: rgba(255,255,255,.60);
      --shadow: 0 16px 40px rgba(18, 43, 66, .14);
      --shadow2: 0 10px 22px rgba(18, 43, 66, .10);
      --r:18px;
      --r2:14px;

      --blue:#5aaeea;
      --mint:#47c7a5;
      --amber:#f4b74a;
      --violet:#8b7cf1;

      --ok:#28b36c;
      --warn:#d48a11;
      --danger:#c84545;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans TC", "Segoe UI", Roboto, Arial, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 650px at 15% 10%, rgba(156, 222, 255, .55) 0%, rgba(156,222,255,0) 60%),
        radial-gradient(1100px 650px at 85% 15%, rgba(185, 255, 225, .55) 0%, rgba(185,255,225,0) 55%),
        radial-gradient(1200px 700px at 50% 95%, rgba(255, 236, 173, .65) 0%, rgba(255,236,173,0) 60%),
        linear-gradient(180deg, #f4fbff 0%, #fbfdff 35%, #fff9f0 100%);
      min-height:100vh;
    }
    .wrap{ max-width:1180px; margin:22px auto 56px; padding:0 16px; }
    header{ text-align:center; padding:6px 0 14px; }
    header h1{ margin:10px 0 6px; font-size:32px; letter-spacing:.4px; }
    header p{ margin:0; color:var(--muted); font-size:14px; line-height:1.5; }

    .grid{ display:grid; grid-template-columns: 430px 1fr; gap:16px; align-items:start; margin-top:12px; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .panel{
      background:var(--card);
      border:1px solid rgba(230,238,247,.95);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      backdrop-filter: blur(12px);
      padding:14px;
    }
    .panelTitle{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin:0 0 10px; }
    .panelTitle h2{ margin:0; font-size:14px; color:#294a64; letter-spacing:.2px; }
    .tiny{ font-size:12px; color:var(--muted); }

    .section{
      background: rgba(255,255,255,.55);
      border:1px solid rgba(230,238,247,.9);
      border-radius:var(--r2);
      box-shadow:var(--shadow2);
      padding:12px;
      margin-bottom:10px;
    }
    .section h3{ margin:0 0 8px; font-size:13px; color:#2b587a; }

    label{ display:block; font-size:12px; color:var(--muted); margin:8px 0 6px; }
    input, select, textarea, button{
      width:100%;
      border-radius:12px;
      border:1px solid rgba(210,224,240,.95);
      background: rgba(255,255,255,.72);
      padding: 11px 12px;
      font-size:14px;
      color:var(--ink);
      outline:none;
    }
    textarea{
      min-height: 108px;
      resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(90,174,234,.75);
      box-shadow: 0 0 0 4px rgba(90,174,234,.15);
    }

    .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .row3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
    @media (max-width:520px){ .row,.row3{ grid-template-columns:1fr; } }

    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .btn{
      width:auto;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      border:1px solid rgba(90,174,234,.55);
      background: linear-gradient(180deg, rgba(90,174,234,.28), rgba(90,174,234,.12));
    }
    .btn.primary{
      border-color: rgba(39,176,138,.55);
      background: linear-gradient(180deg, rgba(39,176,138,.28), rgba(39,176,138,.12));
    }
    .btn.danger{
      border-color: rgba(200,69,69,.45);
      background: linear-gradient(180deg, rgba(200,69,69,.22), rgba(200,69,69,.10));
    }
    .btn:hover{ filter:brightness(.98); }

    .msg{ font-size:12px; margin-top:8px; line-height:1.5; color:var(--muted); white-space:pre-wrap; }
    .msg.ok{ color: var(--ok); }
    .msg.err{ color: var(--danger); }
    .msg.warn{ color: var(--warn); }

    .kpiGrid{ display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; }
    @media (max-width:980px){ .kpiGrid{ grid-template-columns: repeat(2,1fr);} }
    .kpi{
      background: rgba(255,255,255,.62);
      border:1px solid rgba(230,238,247,.95);
      border-radius:var(--r2);
      padding:12px;
      box-shadow:var(--shadow2);
    }
    .kpi .t{ font-size:12px; color:var(--muted); }
    .kpi .v{ font-size:18px; margin-top:6px; font-variant-numeric: tabular-nums; }
    .kpi .s{ font-size:12px; color:var(--muted); margin-top:3px; line-height:1.35; }

    .cards2{ display:grid; grid-template-columns: 1.1fr .9fr; gap:12px; margin-top:12px; }
    @media (max-width:980px){ .cards2{ grid-template-columns:1fr; } }

    table{
      width:100%;
      border-collapse: collapse;
      font-size:13px;
      background: rgba(255,255,255,.55);
      border:1px solid rgba(230,238,247,.95);
      border-radius:var(--r2);
      overflow:hidden;
      box-shadow:var(--shadow2);
    }
    th, td{ border-bottom:1px solid rgba(230,238,247,.95); padding:9px 10px; text-align:left; vertical-align:top; }
    th{ color:#2b587a; font-weight:700; background: rgba(255,255,255,.75); }
    td.right, th.right{ text-align:right; font-variant-numeric: tabular-nums; }
    tr:last-child td{ border-bottom:none; }

    .chartBox{
      background: rgba(255,255,255,.55);
      border:1px solid rgba(230,238,247,.95);
      border-radius:var(--r2);
      box-shadow:var(--shadow2);
      padding:10px;
      margin-top:12px;
    }
    canvas{ width:100%; height:250px; display:block; }

    .footerNote{ margin-top:10px; color:var(--muted); font-size:12px; line-height:1.6; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>ETF 統計計算小工具</h1>
      <p>免費前端版（GitHub Pages）｜一鍵抓今日收盤（TWSE OpenAPI）｜殖利率 / 回本 / DCA / 現金流</p>
    </header>

    <div class="grid">
      <!-- LEFT: Inputs -->
      <div class="panel">
        <div class="panelTitle">
          <h2>輸入與資料抓取</h2>
          <div class="tiny">建議先用「抓今日資料」帶入股價</div>
        </div>

        <div class="section">
          <h3>1) ETF 代號與今日資料（自動）</h3>
          <div class="row">
            <div>
              <label>ETF 代號（例：0056 / 00878）</label>
              <input id="stockNo" placeholder="0056" value="0056" />
            </div>
            <div>
              <label>ETF 名稱（自動帶入，可手改）</label>
              <input id="etfName" placeholder="（抓取後自動填）" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>目前股價（市價）</label>
              <input id="currentPrice" type="number" step="0.01" value="0" />
            </div>
            <div>
              <label>今日收盤日（自動帶入）</label>
              <input id="priceDate" class="mono" placeholder="YYYY-MM-DD" disabled />
            </div>
          </div>

          <div class="btnRow">
            <button class="btn primary" id="btnFetchToday">抓今日資料（OpenAPI）</button>
            <button class="btn" id="btnCalc">計算 / 更新</button>
          </div>
          <div id="msgToday" class="msg"></div>

          <div class="footerNote">
            今日資料抓取端點：<span class="mono">https://openapi.twse.com.tw/v1/exchangeReport/STOCK_DAY_ALL</span>
          </div>
        </div>

        <div class="section">
          <h3>2) 你的持有與成本</h3>
          <div class="row">
            <div>
              <label>目前持有股數（若無填 0）</label>
              <input id="initShares" type="number" step="1" value="0" />
            </div>
            <div>
              <label>已投入成本（總成本）</label>
              <input id="initCost" type="number" step="1" value="0" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>買入手續費率（%）</label>
              <input id="feeRate" type="number" step="0.01" value="0.1425" />
            </div>
            <div>
              <label>稅/其他成本（元，可選）</label>
              <input id="extraCost" type="number" step="1" value="0" />
            </div>
          </div>
          <div class="tiny">總成本 = 已投入成本 + 稅/其他成本（用於回本/成本殖利率計算）</div>
        </div>

        <div class="section">
          <h3>3) 配息設定（平均估算）</h3>
          <div class="row">
            <div>
              <label>每次配息（每股，元）</label>
              <input id="divPerPay" type="number" step="0.0001" value="0.5" />
            </div>
            <div>
              <label>配息頻率</label>
              <select id="divFreq">
                <option value="12">月配（12）</option>
                <option value="6">雙月（6）</option>
                <option value="4">季配（4）</option>
                <option value="2">半年（2）</option>
                <option value="1">年配（1）</option>
                <option value="custom" selected>自訂月份</option>
              </select>
            </div>
          </div>

          <label>發息月（自訂月份，逗號分隔）</label>
          <input id="divMonths" value="1,2,3,4,5,6,7,8,9,10,11,12" />

          <div class="row">
            <div>
              <label>發息日（1~31，現金流顯示用）</label>
              <input id="divDay" type="number" step="1" value="10" />
            </div>
            <div>
              <label>年度股息（每股，元）</label>
              <input id="annualDiv" type="number" step="0.0001" disabled />
            </div>
          </div>

          <div class="tiny">年度股息（每股）= 每次配息 × 發息月數。若配息浮動，先用平均值估算。</div>
        </div>

        <div class="section">
          <h3>4) 持續買入 DCA（簡化）</h3>
          <div class="row">
            <div>
              <label>每月買入金額（元）</label>
              <input id="dcaAmount" type="number" step="1" value="10000" />
            </div>
            <div>
              <label>DCA 月數</label>
              <input id="dcaMonths" type="number" step="1" value="24" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>買入價格來源</label>
              <select id="priceMode">
                <option value="fixed" selected>固定用目前股價</option>
                <option value="history">用歷史股價序列（每月一筆）</option>
              </select>
            </div>
            <div>
              <label>股息再投入（簡化模型）</label>
              <select id="reinvest">
                <option value="no" selected>不再投入（領現金）</option>
                <option value="yes">再投入</option>
              </select>
            </div>
          </div>
        </div>

        <div class="section">
          <h3>5) 歷史股價（月資料）</h3>
          <div class="row">
            <div>
              <label>自動抓取年數（用 TWSE STOCK_DAY）</label>
              <select id="histYears">
                <option value="1">近 1 年</option>
                <option value="3" selected>近 3 年</option>
                <option value="5">近 5 年</option>
              </select>
            </div>
            <div>
              <label>自動抓取（若 CORS 被擋，改用下方貼 CSV）</label>
              <button class="btn" id="btnFetchHist">抓歷史股價（月）</button>
            </div>
          </div>
          <div id="msgHist" class="msg"></div>

          <label>或手動貼上 CSV（每行：YYYY-MM,price）</label>
          <textarea id="priceCsv" placeholder="2024-01,28.50&#10;2024-02,29.10&#10;2024-03,30.20"></textarea>

          <div class="btnRow">
            <button class="btn" id="btnLoadSample">載入範例</button>
            <button class="btn danger" id="btnClearHist">清空歷史資料</button>
            <button class="btn" id="btnSave">儲存設定（本機）</button>
            <button class="btn" id="btnLoad">載入設定（本機）</button>
          </div>

          <div class="tiny">
            歷史抓取使用：<span class="mono">https://www.twse.com.tw/exchangeReport/STOCK_DAY?response=json&date=YYYYMM01&stockNo=代號</span>
          </div>
        </div>
      </div>

      <!-- RIGHT: Outputs -->
      <div class="panel">
        <div class="panelTitle">
          <h2>結果總覽</h2>
          <div class="tiny">以目前輸入 / 抓到的資料即時計算</div>
        </div>

        <div class="kpiGrid" id="kpis"></div>

        <div class="cards2">
          <div>
            <div class="panelTitle" style="margin-top:6px;">
              <h2>年度股息現金流（估算）</h2>
              <div class="tiny">依發息月/日與總持股計算</div>
            </div>
            <table>
              <thead>
                <tr>
                  <th>發息日</th>
                  <th>月份</th>
                  <th class="right">每次股息（元）</th>
                </tr>
              </thead>
              <tbody id="cashflowRows"></tbody>
            </table>
            <div class="footerNote">若你選「股息再投入」，現金流會轉為買入股數（此表仍以「每次股息金額」顯示）。</div>
          </div>

          <div>
            <div class="panelTitle" style="margin-top:6px;">
              <h2>DCA 模擬摘要</h2>
              <div class="tiny">簡化假設每月買入一次</div>
            </div>
            <table>
              <tbody id="dcaSummary"></tbody>
            </table>
          </div>
        </div>

        <div class="chartBox">
          <div class="panelTitle" style="margin:0 0 8px;">
            <h2>歷史股價走勢（簡易線圖）</h2>
            <div class="tiny">月頻資料（或你貼的 CSV）</div>
          </div>
          <canvas id="chart" width="1000" height="300"></canvas>
          <div class="footerNote" id="histMeta"></div>
        </div>

        <div style="margin-top:12px;">
          <div class="panelTitle" style="margin:0 0 8px;">
            <h2>歷史股價統計</h2>
            <div class="tiny">由目前序列計算</div>
          </div>
          <table>
            <tbody id="histStats"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   Helpers
========================= */
const fmt0 = n => isFinite(n) ? n.toLocaleString('zh-TW', { maximumFractionDigits: 0 }) : '-';
const fmt2 = n => isFinite(n) ? n.toLocaleString('zh-TW', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '-';
const fmt4 = n => isFinite(n) ? n.toLocaleString('zh-TW', { minimumFractionDigits: 4, maximumFractionDigits: 4 }) : '-';
const pct2 = n => isFinite(n) ? (n*100).toLocaleString('zh-TW', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + '%' : '-';
const clamp = (v,a,b) => Math.max(a, Math.min(b, v));

function el(id){ return document.getElementById(id); }
function setMsg(id, text, type){
  const m = el(id);
  m.className = 'msg' + (type ? (' ' + type) : '');
  m.textContent = text || '';
}

function parseMonths(s){
  const arr = (s||'').split(',').map(x=>parseInt(x.trim(),10)).filter(x=>Number.isInteger(x)&&x>=1&&x<=12);
  return Array.from(new Set(arr)).sort((a,b)=>a-b);
}
function parsePriceCsv(text){
  const lines = (text||'').split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
  const pts = [];
  for(const line of lines){
    const [d,p] = line.split(',').map(x=>x.trim());
    const price = Number(p);
    if(!d || !isFinite(price) || price<=0) continue;
    pts.push({ date:d, price });
  }
  pts.sort((a,b)=> a.date.localeCompare(b.date));
  return pts;
}
function quantile(sortedArr, q){
  if(sortedArr.length===0) return NaN;
  const pos=(sortedArr.length-1)*q;
  const base=Math.floor(pos);
  const rest=pos-base;
  if(sortedArr[base+1]!==undefined) return sortedArr[base]+rest*(sortedArr[base+1]-sortedArr[base]);
  return sortedArr[base];
}

function monthListFromFreq(freq){
  if(freq===12) return [1,2,3,4,5,6,7,8,9,10,11,12];
  if(freq===6) return [1,3,5,7,9,11];
  if(freq===4) return [1,4,7,10];
  if(freq===2) return [1,7];
  if(freq===1) return [12];
  return [];
}

/* =========================
   Finance logic
========================= */
function calcAnnualDividendPerShare(divPerPay, months){
  return (months.length>0) ? divPerPay * months.length : 0;
}
function computeYields(currentPrice, annualDivPerShare, totalCost, totalShares){
  const marketValue = currentPrice * totalShares;
  const annualIncome = annualDivPerShare * totalShares;
  const yieldOnPrice = currentPrice>0 ? annualDivPerShare/currentPrice : NaN;
  const yieldOnCost = totalCost>0 ? annualIncome/totalCost : NaN;
  const yieldOnMarket = marketValue>0 ? annualIncome/marketValue : NaN;
  return { marketValue, annualIncome, yieldOnPrice, yieldOnCost, yieldOnMarket };
}
function breakevenYears(totalCost, annualIncome){
  if(!(totalCost>0) || !(annualIncome>0)) return NaN;
  return totalCost/annualIncome;
}

function simulateDCA({
  initShares, initCost, feeRatePct, extraCost,
  dcaAmount, dcaMonths, priceMode, currentPrice, priceSeries,
  annualDivPerShare, divMonths,
  reinvest
}){
  const feeRate = clamp(feeRatePct/100, 0, 0.2);
  let shares = initShares;
  let cost = initCost + extraCost;
  let dividendsCash = 0;

  const series = priceSeries || [];
  const getPrice = (i)=>{
    if(priceMode==='history' && series[i] && isFinite(series[i].price)) return series[i].price;
    return currentPrice;
  };
  const monthNum = (i)=> ((i%12)+1);

  for(let i=0;i<dcaMonths;i++){
    const px = getPrice(i);
    if(!(px>0)) continue;
    const netBuy = dcaAmount*(1-feeRate);
    const buyShares = netBuy/px;
    shares += buyShares;
    cost += dcaAmount;

    if(divMonths.includes(monthNum(i)) && divMonths.length>0){
      const divPerPay = annualDivPerShare/divMonths.length;
      const cash = shares * divPerPay;
      if(reinvest==='yes'){
        const reinvestNet = cash*(1-feeRate);
        shares += reinvestNet/px;
      }else{
        dividendsCash += cash;
      }
    }
  }

  const avgCostPerShare = shares>0 ? (cost/shares) : NaN;
  return { shares, cost, dividendsCash, avgCostPerShare };
}

/* =========================
   Rendering
========================= */
function renderKpis(data){
  const k = el('kpis');
  k.innerHTML = '';
  const items = [
    { t:'ETF', v: data.etfLabel || '-', s:'代號/名稱' },
    { t:'目前股價', v: fmt2(data.currentPrice), s:'（自動抓或手動填）' },
    { t:'總持股（股）', v: fmt4(data.totalShares), s:'含原持有 + DCA（含再投入）' },
    { t:'平均成本（元/股）', v: fmt4(data.avgCostPerShare), s:'總成本 ÷ 總持股' },

    { t:'總成本（元）', v: fmt0(data.totalCost), s:'含 DCA + 其他成本' },
    { t:'市值（元）', v: fmt0(data.marketValue), s:'目前股價 × 總持股' },
    { t:'年度股息（每股）', v: fmt4(data.annualDivPerShare), s:'每次配息 × 發息月數' },
    { t:'年度股息（元）', v: fmt0(data.annualIncome), s:'年度股息（每股）× 總持股' },

    { t:'殖利率（以市價）', v: pct2(data.yieldOnPrice), s:'年度股息（每股）÷ 股價' },
    { t:'殖利率（以成本）', v: pct2(data.yieldOnCost), s:'年度股息（元）÷ 總成本' },
    { t:'殖利率（以市值）', v: pct2(data.yieldOnMarket), s:'年度股息（元）÷ 市值' },
    { t:'回本（估算）', v: isFinite(data.beY)? (data.beY.toFixed(2)+' 年'):'-', s:'總成本 ÷ 年度股息（元）' },
  ];

  for(const it of items){
    const d = document.createElement('div');
    d.className = 'kpi';
    d.innerHTML = `<div class="t">${it.t}</div><div class="v">${it.v}</div><div class="s">${it.s}</div>`;
    k.appendChild(d);
  }
}

function renderCashflow(months, day, perPayCash){
  const tbody = el('cashflowRows');
  tbody.innerHTML = '';
  for(const m of months){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="mono">${String(m).padStart(2,'0')}-${String(day).padStart(2,'0')}</td>
                    <td>${m} 月</td>
                    <td class="right">${fmt0(perPayCash)}</td>`;
    tbody.appendChild(tr);
  }
  if(months.length===0){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="3" class="tiny">尚未設定發息月份</td>`;
    tbody.appendChild(tr);
  }
}

function renderDcaSummary(sim, currentPrice, annualDivPerShare){
  const tbody = el('dcaSummary');
  tbody.innerHTML = '';
  const marketValue = sim.shares*currentPrice;
  const annualIncome = sim.shares*annualDivPerShare;

  const rows = [
    ['DCA 後總持股（股）', fmt4(sim.shares)],
    ['DCA 後總成本（元）', fmt0(sim.cost)],
    ['DCA 後市值（元）', fmt0(marketValue)],
    ['DCA 後平均成本（元/股）', fmt4(sim.avgCostPerShare)],
    ['DCA 後年度股息（元）', fmt0(annualIncome)],
    ['（若不再投入）DCA 期間股息現金（元）', fmt0(sim.dividendsCash)]
  ];
  for(const [k,v] of rows){
    const tr = document.createElement('tr');
    tr.innerHTML = `<th>${k}</th><td class="right">${v}</td>`;
    tbody.appendChild(tr);
  }
}

function renderHistStats(series){
  const out = el('histStats');
  out.innerHTML = '';
  if(!series || series.length===0){
    out.innerHTML = `<tr><th>狀態</th><td class="right">未提供歷史股價資料</td></tr>`;
    return;
  }
  const prices = series.map(p=>p.price).filter(x=>isFinite(x)).sort((a,b)=>a-b);
  const min = prices[0], max = prices[prices.length-1];
  const p25 = quantile(prices, .25);
  const p50 = quantile(prices, .50);
  const p75 = quantile(prices, .75);

  const first = series[0], last = series[series.length-1];
  const change = last.price-first.price;
  const changePct = first.price>0 ? change/first.price : NaN;

  const rows = [
    ['筆數（月）', fmt0(series.length)],
    ['期間', `${first.date} → ${last.date}`],
    ['最低價', fmt2(min)],
    ['最高價', fmt2(max)],
    ['中位數', fmt2(p50)],
    ['25% 分位', fmt2(p25)],
    ['75% 分位', fmt2(p75)],
    ['期間變動', `${fmt2(change)}（${pct2(changePct)}）`],
  ];
  for(const [k,v] of rows){
    const tr = document.createElement('tr');
    tr.innerHTML = `<th>${k}</th><td class="right">${v}</td>`;
    out.appendChild(tr);
  }
}

function drawChart(series, currentPrice){
  const canvas = el('chart');
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0,0,w,h);

  // grid
  ctx.strokeStyle = 'rgba(98,114,137,.25)';
  ctx.lineWidth = 1;
  for(let i=1;i<=4;i++){
    const y = (h/5)*i;
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();
  }

  if(!series || series.length<2){
    ctx.fillStyle = 'rgba(98,114,137,.8)';
    ctx.font = '16px -apple-system, BlinkMacSystemFont, "Noto Sans TC", sans-serif';
    ctx.fillText('尚未提供足夠的歷史資料（至少 2 筆）', 20, 40);
    return;
  }

  const prices = series.map(p=>p.price);
  const min = Math.min(...prices);
  const max = Math.max(...prices);
  const pad = (max-min)*0.08 || (max*0.08) || 1;
  const lo = min-pad, hi = max+pad;

  const xFor = i => (i/(series.length-1))*(w-40)+20;
  const yFor = v => (1-((v-lo)/(hi-lo)))*(h-40)+20;

  // line
  ctx.strokeStyle = 'rgba(90,174,234,.95)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  for(let i=0;i<series.length;i++){
    const x=xFor(i), y=yFor(series[i].price);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();

  // current price dashed
  if(isFinite(currentPrice) && currentPrice>0){
    const y=yFor(currentPrice);
    ctx.strokeStyle = 'rgba(71,199,165,.95)';
    ctx.setLineDash([6,6]);
    ctx.beginPath(); ctx.moveTo(20,y); ctx.lineTo(w-20,y); ctx.stroke();
    ctx.setLineDash([]);
  }

  // labels
  ctx.fillStyle = 'rgba(98,114,137,.9)';
  ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace';
  ctx.fillText(`min ${min.toFixed(2)}`, 22, h-18);
  ctx.fillText(`max ${max.toFixed(2)}`, 22, 18);

  ctx.fillStyle = 'rgba(98,114,137,.9)';
  ctx.font = '12px -apple-system, BlinkMacSystemFont, "Noto Sans TC", sans-serif';
  ctx.fillText(series[0].date, 20, h-6);
  const lastTxt = series[series.length-1].date;
  const tw = ctx.measureText(lastTxt).width;
  ctx.fillText(lastTxt, w-20-tw, h-6);
}

/* =========================
   Data fetch
========================= */

// 今日收盤：改用 TWSE CSV（較不容易被 OpenAPI/CORS 卡住）
async function fetchTodayFromOpenAPI(stockNo){
  // 保持函式名不變，避免你後面按鈕事件還要改
  const url = 'https://www.twse.com.tw/exchangeReport/STOCK_DAY_ALL?response=open_data';
  const res = await fetch(url, { cache: 'no-store' });
  if (!res.ok) throw new Error('TWSE CSV 回應失敗：HTTP ' + res.status);

  const text = await res.text();

  // 簡易 CSV 解析（處理雙引號與逗號）
  const lines = text.split(/\r?\n/).filter(Boolean);
  if (lines.length < 2) throw new Error('CSV 內容異常（無資料）');

  // 解析一行 CSV（支援 "0056","元大高股息","1,234" 這種）
  const parseCSVLine = (line) => {
    const out = [];
    let cur = '';
    let inQ = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (ch === '"') { inQ = !inQ; continue; }
      if (ch === ',' && !inQ) { out.push(cur); cur = ''; continue; }
      cur += ch;
    }
    out.push(cur);
    return out.map(s => s.trim());
  };

  // 第一行是欄位名：證券代號,證券名稱,成交股數,...,收盤價,...
  // 我們找出「證券代號」「證券名稱」「收盤價」所在欄位
  const header = parseCSVLine(lines[0]);
  const idxCode = header.indexOf('證券代號');
  const idxName = header.indexOf('證券名稱');
  const idxClose = header.indexOf('收盤價');

  if (idxCode < 0 || idxName < 0 || idxClose < 0) {
    throw new Error('CSV 欄位找不到（欄位名可能變動）');
  }

  const target = String(stockNo).trim();
  let found = null;

  for (let i = 1; i < lines.length; i++) {
    const row = parseCSVLine(lines[i]);
    if (!row[idxCode]) continue;
    if (String(row[idxCode]).trim() === target) {
      found = row;
      break;
    }
  }
  if (!found) throw new Error('找不到代號：' + target + '（可能今日無交易/停牌/代號錯）');

  const name = found[idxName] || '';
  const close = Number(String(found[idxClose] || '').replace(/,/g, ''));
  if (!(close > 0)) throw new Error('收盤價解析失敗：' + found[idxClose]);

  // 這個 CSV 沒有直接給日期：用今天日期當顯示（台北時間）
  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth() + 1).padStart(2, '0');
  const dd = String(now.getDate()).padStart(2, '0');
  const date = `${yyyy}-${mm}-${dd}`;

  return { name, close, date, raw: found };
}

// 月資料：TWSE STOCK_DAY（抓該月最後一日收盤當月收盤）
async function fetchMonthFromTWSE(stockNo, yyyymm){
  const url = `https://www.twse.com.tw/exchangeReport/STOCK_DAY?response=json&date=${yyyymm}01&stockNo=${encodeURIComponent(stockNo)}`;
  const res = await fetch(url, { cache:'no-store' });
  if(!res.ok) throw new Error('TWSE STOCK_DAY 失敗：HTTP ' + res.status);
  const json = await res.json();
  if(!json || !Array.isArray(json.data)) return [];
  const rows = json.data;
  const last = rows[rows.length-1];
  if(!last) return [];
  const closeStr = String(last[6]).replace(/,/g,'');
  const close = Number(closeStr);
  if(!(close>0)) return [];
  const d = String(last[0]); // 例如 "113/01/31"
  const parts = d.split('/');
  if(parts.length<3) return [];
  const y = Number(parts[0]) + 1911;
  const m = String(parts[1]).padStart(2,'0');
  return [{ date: `${y}-${m}`, price: close }];
}

async function fetchHistoryMonths(stockNo, years){
  const months = years*12;
  const now = new Date();
  const list = [];
  for(let i=months-1;i>=0;i--){
    const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    list.push(`${yyyy}${mm}`);
  }
  const out = [];
  for(const yyyymm of list){
    const pts = await fetchMonthFromTWSE(stockNo, yyyymm);
    out.push(...pts);
  }
  const map = new Map();
  for(const p of out) map.set(p.date, p.price);
  const series = Array.from(map.entries()).map(([date, price])=>({date, price}));
  series.sort((a,b)=>a.date.localeCompare(b.date));
  return series;
}

/* =========================
   Main calc
========================= */
function computeAndRender(){
  const stockNo = el('stockNo').value.trim();
  const name = el('etfName').value.trim();
  const currentPrice = Number(el('currentPrice').value);
  const initShares = Number(el('initShares').value);
  const initCost = Number(el('initCost').value);
  const feeRatePct = Number(el('feeRate').value);
  const extraCost = Number(el('extraCost').value);

  const divPerPay = Number(el('divPerPay').value);
  const divFreq = el('divFreq').value;

  let months = parseMonths(el('divMonths').value);
  if(divFreq !== 'custom'){
    const f = parseInt(divFreq,10);
    months = monthListFromFreq(f);
    el('divMonths').value = months.join(',');
  }
  const divDay = clamp(Number(el('divDay').value),1,31);

  const annualDivPerShare = calcAnnualDividendPerShare(divPerPay, months);
  el('annualDiv').value = annualDivPerShare.toFixed(4);

  const dcaAmount = Number(el('dcaAmount').value);
  const dcaMonths = Math.max(0, Math.floor(Number(el('dcaMonths').value)));
  const priceMode = el('priceMode').value;
  const reinvest = el('reinvest').value;

  const series = parsePriceCsv(el('priceCsv').value);

  const sim = simulateDCA({
    initShares, initCost, feeRatePct, extraCost,
    dcaAmount, dcaMonths, priceMode, currentPrice, priceSeries: series,
    annualDivPerShare, divMonths: months,
    reinvest
  });

  const totalShares = sim.shares;
  const totalCost = sim.cost;
  const avgCostPerShare = sim.avgCostPerShare;

  const y = computeYields(currentPrice, annualDivPerShare, totalCost, totalShares);
  const beY = breakevenYears(totalCost, y.annualIncome);

  const perPayDivPerShare = (months.length>0) ? (annualDivPerShare/months.length) : 0;
  const perPayCash = perPayDivPerShare * totalShares;

  const etfLabel = stockNo ? (`${stockNo} ${name||''}`.trim()) : (name||'-');

  renderKpis({
    etfLabel, currentPrice,
    totalShares, totalCost, avgCostPerShare,
    annualDivPerShare,
    marketValue: y.marketValue,
    annualIncome: y.annualIncome,
    yieldOnPrice: y.yieldOnPrice,
    yieldOnCost: y.yieldOnCost,
    yieldOnMarket: y.yieldOnMarket,
    beY
  });

  renderCashflow(months, divDay, perPayCash);
  renderDcaSummary(sim, currentPrice, annualDivPerShare);
  renderHistStats(series);
  drawChart(series, currentPrice);

  if(series.length>=2){
    el('histMeta').textContent = `目前歷史序列：${series[0].date} → ${series[series.length-1].date}（${series.length} 筆，月頻）`;
  }else{
    el('histMeta').textContent = '尚無足夠歷史資料：可按「抓歷史股價」或貼上 CSV。';
  }
}

/* =========================
   Save/Load (localStorage)
========================= */
const LS_KEY = 'etf_tool_v1_twse';
function saveSettings(){
  const payload = {
    stockNo: el('stockNo').value,
    etfName: el('etfName').value,
    currentPrice: el('currentPrice').value,
    priceDate: el('priceDate').value,
    initShares: el('initShares').value,
    initCost: el('initCost').value,
    feeRate: el('feeRate').value,
    extraCost: el('extraCost').value,
    divPerPay: el('divPerPay').value,
    divFreq: el('divFreq').value,
    divMonths: el('divMonths').value,
    divDay: el('divDay').value,
    dcaAmount: el('dcaAmount').value,
    dcaMonths: el('dcaMonths').value,
    priceMode: el('priceMode').value,
    reinvest: el('reinvest').value,
    histYears: el('histYears').value,
    priceCsv: el('priceCsv').value
  };
  localStorage.setItem(LS_KEY, JSON.stringify(payload));
  setMsg('msgHist', '已儲存設定到本機（此裝置瀏覽器）', 'ok');
}
function loadSettings(){
  const raw = localStorage.getItem(LS_KEY);
  if(!raw){ setMsg('msgHist', '本機尚無已儲存的設定', 'warn'); return; }
  try{
    const p = JSON.parse(raw);
    for(const [k,v] of Object.entries(p)){
      const node = el(k);
      if(node) node.value = v;
    }
    setMsg('msgHist', '已載入本機設定', 'ok');
    computeAndRender();
  }catch{
    setMsg('msgHist', '載入失敗：本機設定格式異常', 'err');
  }
}

/* =========================
   Events
========================= */
el('btnCalc').addEventListener('click', computeAndRender);

el('divFreq').addEventListener('change', ()=>{
  computeAndRender();
});

el('btnLoadSample').addEventListener('click', ()=>{
  const sample = [
    '2024-01,28.50','2024-02,29.10','2024-03,30.20','2024-04,29.60',
    '2024-05,30.80','2024-06,31.20','2024-07,32.10','2024-08,31.40',
    '2024-09,30.90','2024-10,31.80','2024-11,32.40','2024-12,33.10'
  ].join('\n');
  el('priceCsv').value = sample;
  setMsg('msgHist', '已載入範例歷史資料', 'ok');
  computeAndRender();
});

el('btnClearHist').addEventListener('click', ()=>{
  el('priceCsv').value = '';
  setMsg('msgHist', '已清空歷史資料', '');
  computeAndRender();
});

el('btnSave').addEventListener('click', saveSettings);
el('btnLoad').addEventListener('click', loadSettings);

// Fetch today
el('btnFetchToday').addEventListener('click', async ()=>{
  const stockNo = el('stockNo').value.trim();
  if(!stockNo){ setMsg('msgToday','請先輸入 ETF 代號（例如 0056）','err'); return; }
  setMsg('msgToday','抓取中…','');
  try{
    const { name, close, date } = await fetchTodayFromOpenAPI(stockNo);
    el('etfName').value = name || el('etfName').value;
    el('currentPrice').value = isFinite(close) ? close : el('currentPrice').value;
    el('priceDate').value = date || '';
    setMsg('msgToday', `成功：${stockNo} ${name}｜收盤 ${fmt2(close)}｜日期 ${date||'（未提供）'}`, 'ok');
    computeAndRender();
  }catch(e){
    setMsg('msgToday', '抓取失敗：' + (e?.message || String(e)), 'err');
  }
});

// Fetch history (monthly)
el('btnFetchHist').addEventListener('click', async ()=>{
  const stockNo = el('stockNo').value.trim();
  if(!stockNo){ setMsg('msgHist','請先輸入 ETF 代號','err'); return; }
  const years = Number(el('histYears').value);
  setMsg('msgHist', `抓取中…（近 ${years} 年，月資料）`, '');
  try{
    const series = await fetchHistoryMonths(stockNo, years);
    if(series.length<2){
      setMsg('msgHist', '抓取完成，但資料筆數不足（可能該代號在此期間資料不足）', 'warn');
    }else{
      const csv = series.map(p=>`${p.date},${p.price.toFixed(2)}`).join('\n');
      el('priceCsv').value = csv;
      setMsg('msgHist', `成功：已載入 ${series.length} 筆月資料（${series[0].date} → ${series[series.length-1].date}）`, 'ok');
    }
    computeAndRender();
  }catch(e){
    setMsg('msgHist',
      '自動抓取失敗（常見原因：瀏覽器跨網域 CORS 限制）。你可以改用「貼上 CSV」方式，或我也能幫你加一個免費代理讓抓取穩定。',
      'err'
    );
  }
});

// init
computeAndRender();
</script>
</body>
</html>
